# Use a lightweight base image
FROM debian:bookworm-slim

WORKDIR /usr/src/app

# Install required packages and cleanup after installation
RUN apt update -y && apt install -y --no-install-recommends \
    curl jq xz-utils file unzip \
    && rm -rf /var/lib/apt/lists/*

# Ensure working directory is writable
RUN chmod 777 /usr/src/app

# Set up Trilium data directory
RUN mkdir -p /root/trilium-data

# Debug: Check if curl and jq are working as expected
RUN echo "Fetching latest beta release..." \
    && curl -s -H "Accept: application/vnd.github.v3+json" \
    https://api.github.com/repos/TriliumNext/Notes/releases \
    | jq -r '[.[] | select(.prerelease)] | first | .assets[] | select(.name | endswith("-server-linux-x64.tar.xz")) | .browser_download_url' \
    && echo "URL fetched successfully."

# Fetch latest release and extract
RUN export TRILIUM_URL=$(curl -s -H "Accept: application/vnd.github.v3+json" \
    https://api.github.com/repos/TriliumNext/Notes/releases | \
    jq -r '[.[] | select(.prerelease)] | first | .assets[] | select(.name | endswith("-server-linux-x64.tar.xz")) | .browser_download_url') \
    && echo "Download URL: $TRILIUM_URL" \
    && curl -L "$TRILIUM_URL" -o trilium.tar.xz \
    && echo "Download completed." \
    && tar -Jxvf trilium.tar.xz --strip-components=1 \
    && echo "Extraction completed." \
    && rm -f trilium.tar.xz  # Cleanup

# Fetch and set up Trilium startup script
RUN curl -sSL "https://gist.githubusercontent.com/mem69/023434b1eb72125de193c6b5780b0b00/raw/trilium.sh" -o trilium.sh \
    && chmod +x trilium.sh

# Expose application port
EXPOSE 8080

# Run application
CMD ["./trilium.sh"]
