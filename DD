FROM alpine:latest

# Set working directory
WORKDIR /usr/src/app

# Install only necessary dependencies
RUN apk add --no-cache \
    curl jq xz && \
    mkdir -p /root/trilium-data

# Fetch latest pre-release of Trilium Notes and extract it
RUN curl -fsSL "$(curl -fsSL -H "Accept: application/vnd.github.v3+json" \
    https://api.github.com/repos/TriliumNext/Notes/releases | \
    jq -r '[.[] | select(.prerelease)] | first | .assets[] | select(.name | endswith("-server-linux-x64.tar.xz")) | .browser_download_url')" | \
    tar -Jx --strip-components=1 -C /usr/src/app

# Download startup script
RUN curl -fsSL https://gist.githubusercontent.com/mem69/023434b1eb72125de193c6b5780b0b00/raw/trilium.sh -o trilium.sh && \
    chmod +x trilium.sh

# Expose port
EXPOSE 8080

# Set execution command
CMD [ "sh", "./trilium.sh" ]
